name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Select Xcode 16.2
        run: sudo xcode-select -switch /Applications/Xcode_16.2.app/Contents/Developer

      - name: Debug - List Repository Files
        run: ls -R
        working-directory: ${{ github.workspace }}

      - name: Install CocoaPods
        run: pod install --repo-update
        working-directory: ${{ github.workspace }}

      - name: Build `.xcframework` (iOS Only)
        run: |
          echo "üöÄ Starting Build for NailDiseaseSDK.xcframework..."

          # Define Build Paths
          BUILD_DIR="build"
          IOS_FRAMEWORK_PATH="${BUILD_DIR}/Build/Products/Release-iphoneos/NailDiseaseSDK.framework"
          SIMULATOR_FRAMEWORK_PATH="${BUILD_DIR}/Build/Products/Release-iphonesimulator/NailDiseaseSDK.framework"
          XCFRAMEWORK_OUTPUT="${BUILD_DIR}/NailDiseaseSDK.xcframework"

          # Clean previous builds
          echo "üßπ Cleaning previous build artifacts..."
          rm -rf "${BUILD_DIR}" NailDiseaseSDK.xcframework

          # Build for iOS (Devices)
          echo "üì± Building for iOS devices..."
          xcodebuild build \
            -workspace NailDiseaseSDK.xcworkspace \
            -scheme NailDiseaseSDK \
            -destination "generic/platform=iOS" \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath "${BUILD_DIR}"

          # Build for iOS Simulator
          echo "üñ•Ô∏è Building for iOS Simulator..."
          xcodebuild build \
            -workspace NailDiseaseSDK.xcworkspace \
            -scheme NailDiseaseSDK \
            -destination "generic/platform=iOS Simulator" \
            -configuration Release \
            -sdk iphonesimulator \
            -derivedDataPath "${BUILD_DIR}"

          # Verify framework paths before creating .xcframework
          if [[ ! -d "$IOS_FRAMEWORK_PATH" || ! -d "$SIMULATOR_FRAMEWORK_PATH" ]]; then
              echo "‚ùå ERROR: Frameworks not found in expected locations!"
              echo "Check build output with: find ${BUILD_DIR} -name 'NailDiseaseSDK.framework'"
              exit 1
          fi

          # Create .xcframework
          echo "üîó Creating .xcframework..."
          xcodebuild -create-xcframework \
            -framework "$IOS_FRAMEWORK_PATH" \
            -framework "$SIMULATOR_FRAMEWORK_PATH" \
            -output "$XCFRAMEWORK_OUTPUT"

          # Verify the exported .xcframework
          echo "üìÇ Verifying .xcframework structure..."
          ls -R "$XCFRAMEWORK_OUTPUT"

          # Zip the .xcframework for easy distribution
          echo "üì¶ Zipping the .xcframework..."
          zip -r NailDiseaseSDK.xcframework.zip "$XCFRAMEWORK_OUTPUT"

          echo "‚úÖ Build complete! Your .xcframework is ready: NailDiseaseSDK.xcframework.zip"

        working-directory: ${{ github.workspace }}

      - name: Upload `.xcframework` as an Artifact
        uses: actions/upload-artifact@v4
        with:
          name: NailDiseaseSDK.xcframework.zip
          path: ${{ github.workspace }}/build/NailDiseaseSDK.xcframework.zip
