name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Debug - List Repository Files
        run: ls -R
        working-directory: ${{ github.workspace }}

      - name: Install CocoaPods
        run: pod install --repo-update
        working-directory: ${{ github.workspace }}

      - name: Build `.xcframework` (iOS Only)
        run: |
          xcodebuild archive \
            -workspace NailDiseaseSDK.xcworkspace \
            -scheme NailDiseaseSDK \
            -destination "generic/platform=iOS" \
            -archivePath "build/NailDiseaseSDK.framework-iphoneos.xcarchive" \
            SKIP_INSTALL=NO BUILD_LIBRARY_FOR_DISTRIBUTION=YES

          xcodebuild archive \
            -workspace NailDiseaseSDK.xcworkspace \
            -scheme NailDiseaseSDK \
            -destination "generic/platform=iOS Simulator" \
            -archivePath "build/NailDiseaseSDK.framework-iphonesimulator.xcarchive" \
            SKIP_INSTALL=NO BUILD_LIBRARY_FOR_DISTRIBUTION=YES

          xcodebuild -create-xcframework \
            -framework build/NailDiseaseSDK.framework-iphoneos.xcarchive/Products/Library/Frameworks/NailDiseaseSDK.framework \
            -framework build/NailDiseaseSDK.framework-iphonesimulator.xcarchive/Products/Library/Frameworks/NailDiseaseSDK.framework \
            -output build/NailDiseaseSDK.xcframework
        working-directory: ${{ github.workspace }}

      - name: Upload Artifact (XCFramework)
        uses: actions/upload-artifact@v4
        with:
          name: NailDiseaseSDK.xcframework
          path: ${{ github.workspace }}/build/NailDiseaseSDK.xcframework
