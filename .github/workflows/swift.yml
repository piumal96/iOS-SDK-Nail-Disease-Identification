name: CI Pipeline

on:
  push:
    tags:
      - "v*.*.*" 
  pull_request:
    branches: [main]
  workflow_dispatch: 

permissions:
  contents: write 

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Select Xcode 16.2
        run: sudo xcode-select -switch /Applications/Xcode_16.2.app/Contents/Developer

      - name: Verify Xcode Version
        run: xcodebuild -version

      - name: Clean and Reset Build Cache
        run: |
          rm -rf ~/Library/Developer/Xcode/DerivedData
          rm -rf ~/Library/Caches/CocoaPods
          pod deintegrate
          pod install --repo-update
        working-directory: ${{ github.workspace }}

      - name: Build `.xcframework`
        run: |
          echo "🚀 Starting Build for NailDiseaseSDK.xcframework..."

          # Define paths
          BUILD_DIR="${{ github.workspace }}/build"
          XCFRAMEWORK_PATH="${BUILD_DIR}/NailDiseaseSDK.xcframework"
          ZIP_FILE="${BUILD_DIR}/NailDiseaseSDK.xcframework.zip"

          # Clean previous builds
          echo "🧹 Cleaning previous artifacts..."
          rm -rf "$BUILD_DIR"

          # Build for iOS devices
          echo "📱 Building for iOS devices..."
          xcodebuild build \
            -workspace NailDiseaseSDK.xcworkspace \
            -scheme NailDiseaseSDK \
            -destination "generic/platform=iOS" \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath "$BUILD_DIR" \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
            SKIP_INSTALL=NO

          echo "🖥️ Building for iOS Simulator..."
          xcodebuild build \
            -workspace NailDiseaseSDK.xcworkspace \
            -scheme NailDiseaseSDK \
            -destination "generic/platform=iOS Simulator" \
            -configuration Release \
            -sdk iphonesimulator \
            -derivedDataPath "$BUILD_DIR" \
            BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
            SKIP_INSTALL=NO

          # Locate built frameworks
          IOS_FRAMEWORK_PATH="$BUILD_DIR/Build/Products/Release-iphoneos/NailDiseaseSDK.framework"
          SIMULATOR_FRAMEWORK_PATH="$BUILD_DIR/Build/Products/Release-iphonesimulator/NailDiseaseSDK.framework"

          # Verify framework paths
          [[ -d "$IOS_FRAMEWORK_PATH" && -d "$SIMULATOR_FRAMEWORK_PATH" ]] || {
            echo "❌ ERROR: Frameworks not found!"
            find "$BUILD_DIR" -name 'NailDiseaseSDK.framework'
            exit 1
          }

          # Create `.xcframework`
          echo "🔗 Creating .xcframework..."
          xcodebuild -create-xcframework \
            -framework "$IOS_FRAMEWORK_PATH" \
            -framework "$SIMULATOR_FRAMEWORK_PATH" \
            -allow-internal-distribution \
            -output "$XCFRAMEWORK_PATH"

          # Zip `.xcframework`
          echo "📦 Creating ZIP archive..."
          (cd "$BUILD_DIR" && zip -r "$(basename "$ZIP_FILE")" "$(basename "$XCFRAMEWORK_PATH")")

          # Confirm ZIP exists
          [[ -f "$ZIP_FILE" ]] || {
            echo "❌ ERROR: ZIP file not created!"
            exit 1
          }

          echo "✅ Build complete! Ready for upload: $ZIP_FILE"

        working-directory: ${{ github.workspace }}

      - name: Compute Checksum
        id: checksum
        run: |
          CHECKSUM=$(swift package compute-checksum build/NailDiseaseSDK.xcframework.zip)
          echo "CHECKSUM=$CHECKSUM" >> $GITHUB_ENV

      - name: Create GitHub Release & Upload `.xcframework`
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}  # Use the pushed tag dynamically
          name: "NailDiseaseSDK Release ${{ github.ref_name }}"
          body: "Automated release of NailDiseaseSDK version ${{ github.ref_name }}"
          draft: false
          prerelease: false
          files: |
            build/NailDiseaseSDK.xcframework.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update `Package.swift` with New Checksum & Version
        run: |
          sed -i '' 's|YOUR_CHECKSUM_HERE|${{ env.CHECKSUM }}|g' Package.swift
          sed -i '' 's|v1.0.0|${{ github.ref_name }}|g' Package.swift
        working-directory: ${{ github.workspace }}

      - name: Commit & Push Updated `Package.swift`
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Package.swift
          git commit -m "📦 Updated Package.swift for release ${{ github.ref_name }}"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
